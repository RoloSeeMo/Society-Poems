<!DOCTYPE html>
<html>
<head>
  <title>Login Page</title>
  <link rel="stylesheet" href="phoneLogin.css">
  <link rel="icon" href="images/Untitled1.png">
  <script type="module" src="firebase-config.js"></script>
  <script src="https://www.google.com/recaptcha/api.js" async defer></script>
  <script type="module" src="auth__set_language_code.js"></script>
  <style>
    /* Additional styles */
    .loginformcontainer {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center; /* Center vertically */
      margin: auto;
      width: 100%;
      max-width: 400px;
      min-height: 100vh;
      padding: 20px;
      box-sizing: border-box;
    }

    .loginformcontainer h1 {
      text-align: center;
      margin-bottom: 30px;
      color: var(--text-primary);
      font-size: var(--font-size-xx1);
      font-weight: var(--font-weight-bold);
    }

    .error-message {
      color: #dc3545;
      background-color: #f8d7da;
      border: 1px solid #f5c6cb;
      padding: 15px;
      border-radius: var(--border-radius-s);
      margin-bottom: 20px;
      display: none;
      font-size: var(--font-size-s);
      text-align: left;
      width: 100%;
      box-sizing: border-box;
    }
    
    .success-message {
      color: #155724;
      background-color: #d4edda;
      border: 1px solid #c3e6cb;
      padding: 15px;
      border-radius: var(--border-radius-s);
      margin-bottom: 20px;
      display: none;
      font-size: var(--font-size-s);
      text-align: left;
      width: 100%;
      box-sizing: border-box;
    }

    .login_form {
      width: 100%;
      max-width: 350px;
      background: var(--bg-secondary, #fff);
      padding: 30px;
      border-radius: var(--border-radius-m);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      box-sizing: border-box;
    }

    .login_form button {
      width: 100%;
      padding: 12px;
      margin: 10px 0;
      border: none;
      border-radius: var(--border-radius-s);
      cursor: pointer;
      font-size: var(--font-size-n);
      font-weight: var(--font-weight-medium);
      transition: all 0.3s ease;
      font-family: "Poppins", sans-serif;
    }
    
    #enterBTN {
      background-color: var(--primary-color);
      color: var(--secondary-color);
    }
    
    #enterBTN:hover:not(:disabled) {
      background-color: var(--primary-color-400);
      transform: translateY(-2px);
    }
    
    /* Removed Google Sign-in button styles as it's no longer in this file */
    
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none !important;
    }

    .login_form label {
      display: block;
      text-align: left;
      margin-bottom: 8px;
      font-weight: var(--font-weight-medium);
      color: var(--text-primary);
      font-size: var(--font-size-n);
    }
    
    .login_form input { /* Adjusted to target all inputs if needed */
      width: 100%;
      padding: 12px;
      margin-bottom: 15px;
      border: 1px solid var(--border-color, #ccc);
      border-radius: var(--border-radius-s);
      background: var(--bg-secondary, #fff);
      color: var(--text-primary);
      font-size: var(--font-size-n);
      box-sizing: border-box;
      font-family: "Poppins", sans-serif;
    }

    .login_form input:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 2px rgba(107, 66, 38, 0.2);
    }

    /* Night theme adjustments for new elements */
    [data-theme="night"] .loginformcontainer h1 {
      color: var(--text-primary);
    }

    [data-theme="night"] .login_form {
      background: var(--bg-secondary);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
    }

    [data-theme="night"] .error-message {
      background-color: #2d1b1e;
      border-color: #842029;
      color: #ea868f;
    }
    
    [data-theme="night"] .success-message {
      background-color: #0f2419;
      border-color: #0a3622;
      color: #75b798;
    }

    [data-theme="night"] .login_form input {
      background: var(--bg-secondary);
      border-color: var(--border-color);
      color: var(--text-primary);
    }

    [data-theme="night"] .login_form input:focus {
      border-color: var(--primary-color-200);
      box-shadow: 0 0 0 2px rgba(201, 123, 99, 0.2);
    }

    /* Responsive adjustments */
    @media screen and (max-width: 640px) {
      .loginformcontainer {
        padding: 15px;
        width: 100%;
      }
      
      .login_form {
        padding: 20px;
      }
      
      .loginformcontainer h1 {
        font-size: var(--font-size-x1);
      }
    }
  </style>
</head>

<body data-theme="night">
  <div class="loginformcontainer">
    <h1>Login</h1>
    
    <form class="login_form" id="number-form" method="POST" action="?">
      <div id="error-container" class="error-message"></div>
      <div id="success-container" class="success-message"></div>
      <label for="code-input">Phone Number:</label>

      <input style="color: white;" name="code-input" id="code-input" class="code-input border--is-interactive" inputmode="numeric" pattern="[0-9]*" maxlength="12" autocomplete="off" data-lpignore="true" value placeholder="XXX-XXX-XXXX" required>

      <script>
        const input = document.getElementById('code-input');
          input.addEventListener('input', function (e) {
            // Strip all non-digit characters (including hyphens)
            let digits = e.target.value.replace(/\D/g, '');

            // Limit to 10 digits
            if (digits.length > 10) digits = digits.slice(0, 10);

            // Format as XXX-XXX-XXXX
            let formatted = '';
            if (digits.length > 6) {
              formatted = `${digits.slice(0,3)}-${digits.slice(3,6)}-${digits.slice(6)}`;
            } else if (digits.length > 3) {
              formatted = `${digits.slice(0,3)}-${digits.slice(3)}`;
            } else {
              formatted = digits;
            }

            e.target.value = formatted;
            });
      </script>

      <button type="button" id="enterBTN" onclick="sendOtp()">Send One-Time Code</button>
      
      <label for="otp-input" style="display:none;" id="otp-label">Verification Code:</label>
      <input type="text" id="otp-input" style="display:none; color:white;" placeholder="Enter OTP" required>
      <button type="button" id="verifyOTPBtn" onclick="verifyOtp()" style="display:none;">Verify Code</button>

      <button type="button" id="backBTN" onclick='window.location.href= "login.html"'>‚Üê</button>
    </form>
    
  </div>

  <script type="module">
    import { auth } from './firebase-config.js'; // Import auth from centralized config
    import { 
        signInWithPhoneNumber, 
        RecaptchaVerifier, 
        onAuthStateChanged 
    } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js'; // Import specific auth functions
    import './auth_phone_recaptcha_verifier_invisible.js'; // Import reCAPTCHA initialization.

    let confirmationResult; // To store the confirmation result for OTP verification

    // Function to show error messages
    function showError(message) {
      const errorContainer = document.getElementById('error-container');
      const successContainer = document.getElementById('success-container');
      
      successContainer.style.display = 'none';
      errorContainer.textContent = message;
      errorContainer.style.display = 'block';
      
      // Auto-hide error after 10 seconds
      setTimeout(() => {
        errorContainer.style.display = 'none';
      }, 10000);
    }

    // Function to show success messages
    function showSuccess(message) {
      const errorContainer = document.getElementById('error-container');
      const successContainer = document.getElementById('success-container');
      
      errorContainer.style.display = 'none';
      successContainer.textContent = message;
      successContainer.style.display = 'block';
    }

    // Function to hide all messages
    function hideMessages() {
      document.getElementById('error-container').style.display = 'none';
      document.getElementById('success-container').style.display = 'none';
    }

    // Function to set loading state
    function setLoading(isLoading, buttonId = null) {
      const button = document.getElementById(buttonId);
      if (button) {
          button.disabled = isLoading;
          if (button.id === 'enterBTN') {
              button.textContent = isLoading ? 'Sending...' : 'Send One-Time Code';
          } else if (button.id === 'verifyOTPBtn') {
              button.textContent = isLoading ? 'Verifying...' : 'Verify Code';
          }
      }
    }

    // Function to check if a user is logged in or not (made global)
    window.checkAuthState = function() { // Made global by attaching to window
      onAuthStateChanged(auth, (user) => {
        if (user) {
          console.log("User is signed in:", user.phoneNumber || user.email); // User might have phone or email
          showSuccess("Login successful! Redirecting...");
          setTimeout(() => {
            window.location.href = "index.html";
          }, 1500);
        } else {
          console.log("No user signed in");
        }
      });
    }

    // Function to handle sending the OTP 
    window.sendOtp = async function() { 
        hideMessages(); 
        setLoading(true, 'enterBTN'); 
        
        const phoneNumberInput = document.getElementById("code-input").value.trim(); 
        // Assuming US numbers for +1. Adjust this if you need international numbers. 
        const phoneNumber = `+1${phoneNumberInput.replace(/\D/g, '')}`; 

        if (!phoneNumberInput) { 
            showError("Please enter your phone number."); 
            setLoading(false, 'enterBTN'); 
            return; 
        }

        // Ensure recaptchaVerifier is available
        const appVerifier = window.recaptchaVerifier; 
        if (!appVerifier) {
            showError("reCAPTCHA is not ready. Please try again or refresh the page.");
            setLoading(false, 'enterBTN');
            console.error("reCAPTCHA verifier is undefined when sendOtp was called.");
            return;
        }

        try { 
            confirmationResult = await signInWithPhoneNumber(auth, phoneNumber, appVerifier); 
            showSuccess("OTP sent successfully! Please check your phone."); 
            // Show OTP input and verify button 
            document.getElementById('otp-label').style.display = 'block'; 
            document.getElementById('otp-input').style.display = 'block'; 
            document.getElementById('verifyOTPBtn').style.display = 'block'; 
            document.getElementById('enterBTN').style.display = 'none'; // Hide send OTP button 
            document.getElementById('code-input').disabled = true; // Disable phone input after sending OTP 

        } catch (error) { 
            setLoading(false, 'enterBTN'); 
            let errorMessage = "Failed to send OTP. Please try again."; 
            console.error("Error sending OTP:", error); 
            switch(error.code) { 
                case 'auth/invalid-phone-number': 
                    errorMessage = "The phone number entered is invalid."; 
                    break; 
                case 'auth/too-many-requests': 
                    errorMessage = "Too many requests. Please try again later."; 
                    break; 
                case 'auth/network-request-failed': 
                    errorMessage = "Network error. Please check your internet connection."; 
                    break; 
                default: 
                    errorMessage = `Error: ${error.message}`; 
            }
            showError(errorMessage); 
        }
    };

    // Function to handle OTP verification 
    window.verifyOtp = async function() { 
        hideMessages(); 
        setLoading(true, 'verifyOTPBtn'); 

        const otpCode = document.getElementById("otp-input").value.trim(); 

        if (!otpCode) { 
            showError("Please enter the verification code."); 
            setLoading(false, 'verifyOTPBtn'); 
            return; 
        }

        if (!confirmationResult) { 
            showError("No verification code was sent. Please send OTP first."); 
            setLoading(false, 'verifyOTPBtn'); 
            return; 
        }

        try { 
            const userCredential = await confirmationResult.confirm(otpCode); 
            console.log("Phone login successful:", userCredential.user.phoneNumber); 
            showSuccess("Login successful! Redirecting..."); 
            setTimeout(() => { 
                window.location.href = "index.html"; 
            }, 1500); 
        } catch (error) { 
            setLoading(false, 'verifyOTPBtn'); 
            let errorMessage = "Invalid verification code. Please try again."; 
            console.error("Error verifying OTP:", error); 
            switch(error.code) { 
                case 'auth/invalid-verification-code': 
                    errorMessage = "The verification code is invalid."; 
                    break; 
                case 'auth/code-expired': 
                    errorMessage = "The verification code has expired."; 
                    break; 
                case 'auth/too-many-requests': 
                    errorMessage = "Too many attempts. Please try again later."; 
                    break; 
                case 'auth/network-request-failed': 
                    errorMessage = "Network error. Please check your internet connection."; 
                    break; 
                default: 
                    errorMessage = `Error: ${error.message}`; 
            }
            showError(errorMessage); 
        }
    };

    // Trigger sendOtp on Enter key press in phone input 
    document.getElementById("code-input").addEventListener("keydown", function(event) { 
        if (event.key === "Enter") { 
            event.preventDefault(); 
            sendOtp(); 
        }
    });

    // Trigger verifyOtp on Enter key press in OTP input 
    document.getElementById("otp-input").addEventListener("keydown", function(event) { 
        if (event.key === "Enter") { 
            event.preventDefault(); 
            verifyOtp(); 
        }
    });

    // Debug function (updated for v9) 
    function debugFirebaseConfig() { 
      console.log("Auth instance available:", !!auth); 
      console.log("Current domain:", window.location.hostname); 
    }

    // Call debug function and checkAuthState on DOM content loaded 
    document.addEventListener('DOMContentLoaded', () => { 
        debugFirebaseConfig();
        window.checkAuthState(); 
    });
  </script>
</body>
</html>