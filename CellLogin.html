<!DOCTYPE html>
<html>
<head>
  <title>Login Page</title>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-auth.js"></script>
  <script src="auth_phone_recaptcha_verifier_invisible.js"></script>
  <script src="auth__set_language_code.js"></script>
  <link rel="stylesheet" href="login.css">
  <link rel="icon" href="images/Untitled1.png">

  <script>
    // Initialize Firebase with project config
    const firebaseConfig = {
      apiKey: "AIzaSyDHXEMtVPn46b2qS1CPGUIEuQ8ntLyvLVM",
      authDomain: "society-poems-97f4d.firebaseapp.com",
      databaseURL: "https://society-poems-97f4d-default-rtdb.firebaseio.com",
      projectId: "society-poems-97f4d",
      storageBucket: "society-poems-97f4d.firebasestorage.app",
      messagingSenderId: "723670230106",
      appId: "1:723670230106:web:6d6dda4f8c46626c55a463"
    };
    firebase.initializeApp(firebaseConfig);
  </script>

  <style>
    /* Additional styles to complement your existing CSS and ensure proper centering */
    .loginformcontainer {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center; /* Center vertically */
      margin: auto;
      width: 100%;
      max-width: 400px;
      min-height: 100vh;
      padding: 20px;
      box-sizing: border-box;
    }

    .loginformcontainer h1 {
      text-align: center;
      margin-bottom: 30px;
      color: var(--text-primary);
      font-size: var(--font-size-xx1);
      font-weight: var(--font-weight-bold);
    }

    .error-message {
      color: #dc3545;
      background-color: #f8d7da;
      border: 1px solid #f5c6cb;
      padding: 15px;
      border-radius: var(--border-radius-s);
      margin-bottom: 20px;
      display: none;
      font-size: var(--font-size-s);
      text-align: left;
      width: 100%;
      box-sizing: border-box;
    }
    
    .success-message {
      color: #155724;
      background-color: #d4edda;
      border: 1px solid #c3e6cb;
      padding: 15px;
      border-radius: var(--border-radius-s);
      margin-bottom: 20px;
      display: none;
      font-size: var(--font-size-s);
      text-align: left;
      width: 100%;
      box-sizing: border-box;
    }

    .login_form {
      width: 100%;
      max-width: 350px;
      background: var(--bg-secondary, #fff);
      padding: 30px;
      border-radius: var(--border-radius-m);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      box-sizing: border-box;
    }

    .login_form button {
      width: 100%;
      padding: 12px;
      margin: 10px 0;
      border: none;
      border-radius: var(--border-radius-s);
      cursor: pointer;
      font-size: var(--font-size-n);
      font-weight: var(--font-weight-medium);
      transition: all 0.3s ease;
      font-family: "Poppins", sans-serif;
    }
    
    #enterBTN {
      background-color: var(--primary-color);
      color: var(--secondary-color);
    }
    
    #enterBTN:hover:not(:disabled) {
      background-color: var(--primary-color-400);
      transform: translateY(-2px);
    }
    
    #google-signin-btn {
      background-color: #4285f4;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
    
    #google-signin-btn:hover:not(:disabled) {
      background-color: #357ae8;
      transform: translateY(-2px);
    }
    
    #google-signin-btn img {
      height: 20px;
      width: 20px;
    }
    
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none !important;
    }

    .login_form label {
      display: block;
      text-align: left;
      margin-bottom: 8px;
      font-weight: var(--font-weight-medium);
      color: var(--text-primary);
      font-size: var(--font-size-n);
    }
    
    .login_form input[type="email"],
    .login_form input[type="password"] {
      width: 100%;
      padding: 12px;
      margin-bottom: 15px;
      border: 1px solid var(--border-color, #ccc);
      border-radius: var(--border-radius-s);
      background: var(--bg-secondary, #fff);
      color: var(--text-primary);
      font-size: var(--font-size-n);
      box-sizing: border-box;
      font-family: "Poppins", sans-serif;
    }

    .login_form input[type="email"]:focus,
    .login_form input[type="password"]:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 2px rgba(107, 66, 38, 0.2);
    }

    /* Night theme adjustments for new elements */
    [data-theme="night"] .loginformcontainer h1 {
      color: var(--text-primary);
    }

    [data-theme="night"] .login_form {
      background: var(--bg-secondary);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
    }

    [data-theme="night"] .error-message {
      background-color: #2d1b1e;
      border-color: #842029;
      color: #ea868f;
    }
    
    [data-theme="night"] .success-message {
      background-color: #0f2419;
      border-color: #0a3622;
      color: #75b798;
    }

    [data-theme="night"] .login_form input[type="email"],
    [data-theme="night"] .login_form input[type="password"] {
      background: var(--bg-secondary);
      border-color: var(--border-color);
      color: var(--text-primary);
    }

    [data-theme="night"] .login_form input[type="email"]:focus,
    [data-theme="night"] .login_form input[type="password"]:focus {
      border-color: var(--primary-color-200);
      box-shadow: 0 0 0 2px rgba(201, 123, 99, 0.2);
    }

    /* Responsive adjustments */
    @media screen and (max-width: 640px) {
      .loginformcontainer {
        padding: 15px;
        width: 100%;
      }
      
      .login_form {
        padding: 20px;
      }
      
      .loginformcontainer h1 {
        font-size: var(--font-size-x1);
      }
    }
  </style>
</head>

<body onload="checkAuthState()" data-theme="night">
  <div class="loginformcontainer">
    <h1>Login</h1>
    <form class="login_form">
      <div id="error-container" class="error-message"></div>
      <div id="success-container" class="success-message"></div>
      <label for="email">Phone Number:</label>

      <input name="code-input" id="code-input" class="code-input border--is-interactive " inputmode="numeric" pattern="[0-9]*" maxlength="6" autocomplete="off" data-lpignore="true" value>

      <button type="button" id="enterBTN" onclick="login()">Continue</button>
    </form>
  </div>

  <script>
    const auth = firebase.auth();
    
    // Configure Google provider with additional scopes and custom parameters
    const provider = new firebase.auth.GoogleAuthProvider();
    provider.addScope('email');
    provider.addScope('profile');
    provider.setCustomParameters({
      'prompt': 'select_account'
    });

    // Function to show error messages
    function showError(message) {
      const errorContainer = document.getElementById('error-container');
      const successContainer = document.getElementById('success-container');
      
      successContainer.style.display = 'none';
      errorContainer.textContent = message;
      errorContainer.style.display = 'block';
      
      // Auto-hide error after 10 seconds
      setTimeout(() => {
        errorContainer.style.display = 'none';
      }, 10000);
    }

    // Function to show success messages
    function showSuccess(message) {
      const errorContainer = document.getElementById('error-container');
      const successContainer = document.getElementById('success-container');
      
      errorContainer.style.display = 'none';
      successContainer.textContent = message;
      successContainer.style.display = 'block';
    }

    // Function to hide all messages
    function hideMessages() {
      document.getElementById('error-container').style.display = 'none';
      document.getElementById('success-container').style.display = 'none';
    }

    // Function to set loading state
    function setLoading(isLoading, buttonId = null) {
      const buttons = buttonId ? [document.getElementById(buttonId)] : [document.getElementById('enterBTN'), document.getElementById('google-signin-btn')];
      
      buttons.forEach(button => {
        if (button) {
          button.disabled = isLoading;
          if (button.id === 'google-signin-btn') {
            const text = button.querySelector('#google-btn-text');
            if (text) {
              text.textContent = isLoading ? 'Signing in...' : 'Sign in with Google';
            }
          } else if (button.id === 'enterBTN') {
            button.textContent = isLoading ? 'Logging in...' : 'Login';
          }
        }
      });
    }

    // Function to check if a user is logged in or not
    function checkAuthState() {
      firebase.auth().onAuthStateChanged(function(user) {
        if (user) {
          console.log("User is signed in:", user.email);
          showSuccess("Login successful! Redirecting...");
          setTimeout(() => {
            window.location.href = "index.html";
          }, 1500);
        } else {
          console.log("No user signed in");
        }
      });
    }

    // Function to handle the login form submission
    function login() {
      hideMessages();
      setLoading(true, 'enterBTN');
      
      const code = document.getElementById("code").value.trim();

      firebase.auth().signInWithPhone(code)
        .then(function(userCredential) {
          console.log("Login successful:", userCredential.user.email);
          showSuccess("Login successful! Redirecting...");
          setTimeout(() => {
            window.location.href = "index.html";
          }, 1500);
        })
        .catch(function(error) {
          setLoading(false, 'enterBTN');
          let errorMessage = "Login failed. Please try again.";
          
          switch(error.code) {
            case 'auth/user-not-found':
              errorMessage = "No account found with this email address.";
              break;
            case 'auth/wrong-password':
              errorMessage = "Incorrect password.";
              break;
            case 'auth/invalid-email':
              errorMessage = "Invalid email address.";
              break;
            case 'auth/invalid-login-credentials':
            case 'auth/invalid-credential':
              errorMessage = "Invalid email or password. Please check your credentials and try again.";
              break;
            case 'auth/too-many-requests':
              errorMessage = "Too many failed attempts. Please try again later.";
              break;
            case 'auth/user-disabled':
              errorMessage = "This account has been disabled.";
              break;
            case 'auth/network-request-failed':
              errorMessage = "Network error. Please check your internet connection.";
              break;
            case 'auth/internal-error':
              errorMessage = "Account not found/Credentials Invalid. Please try again or sign up";
              break;
            default:
              // Only show the technical error in development, user-friendly message in production
              if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                errorMessage = `Login error: ${error.message}`;
              } else {
                errorMessage = "Login failed. Please check your credentials and try again.";
              }
              console.error("Unhandled login error:", error.code, error.message);
          }
          
          showError(errorMessage);
          console.error("Login error:", error.code, error.message);
        });
    }

    // Google Sign-in functionality with better error handling
    document.getElementById('google-signin-btn').addEventListener('click', function() {
      hideMessages();
      setLoading(true, 'google-signin-btn');
      
      console.log("Attempting Google sign-in...");
      
      auth.signInWithPopup(provider)
        .then((result) => {
          const user = result.user;
          const credential = firebase.auth.GoogleAuthProvider.credentialFromResult(result);
          
          console.log("Google sign-in successful:", {
            name: user.displayName,
            email: user.email,
            uid: user.uid
          });
          
          showSuccess(`Welcome ${user.displayName}! Redirecting...`);
          setTimeout(() => {
            window.location.href = "index.html";
          }, 1500);
        })
        .catch((error) => {
          setLoading(false, 'google-signin-btn');
          console.error("Google sign-in error:", error);
          
          let errorMessage = "Google sign-in failed. ";
          
          switch(error.code) {
            case 'auth/popup-closed-by-user':
              errorMessage += "Sign-in was cancelled.";
              break;
            case 'auth/popup-blocked':
              errorMessage += "Pop-up was blocked. Please allow pop-ups and try again.";
              break;
            case 'auth/cancelled-popup-request':
              errorMessage += "Another sign-in popup is already open.";
              break;
            case 'auth/operation-not-allowed':
              errorMessage += "Google sign-in is not enabled. Please contact support.";
              break;
            case 'auth/invalid-api-key':
              errorMessage += "Invalid API key configuration.";
              break;
            case 'auth/network-request-failed':
              errorMessage += "Network error. Please check your connection.";
              break;
            case 'auth/too-many-requests':
              errorMessage += "Too many requests. Please try again later.";
              break;
            default:
              errorMessage += `Error: ${error.message}`;
          }
          
          showError(errorMessage);
          
          // If popup fails, suggest trying redirect method
          if (error.code === 'auth/popup-blocked' || error.code === 'auth/popup-closed-by-user') {
            setTimeout(() => {
              if (confirm("Pop-up sign-in failed. Try redirect sign-in instead?")) {
                auth.signInWithRedirect(provider);
              }
            }, 2000);
          }
        });
    });

    // Handle redirect result (in case redirect method was used)
    auth.getRedirectResult().then((result) => {
      if (result.user) {
        console.log("Google redirect sign-in successful:", result.user.displayName);
        showSuccess(`Welcome ${result.user.displayName}! Redirecting...`);
        setTimeout(() => {
          window.location.href = "index.html";
        }, 1500);
      }
    }).catch((error) => {
      console.error("Google redirect sign-in error:", error);
      showError(`Redirect sign-in failed: ${error.message}`);
    });

    // Trigger login on Enter key press
    document.querySelector('.login_form').addEventListener('keydown', function(event) {
      if (event.key === 'Enter') {
        event.preventDefault();
        login();
      }
    });

    // Individual input field Enter key handling
    document.getElementById("email").addEventListener("keydown", function(event) {
      if (event.key === "Enter") {
        event.preventDefault();
        document.getElementById("password").focus();
      }
    });

    document.getElementById("password").addEventListener("keydown", function(event) {
      if (event.key === "Enter") {
        event.preventDefault();
        login();
      }
    });

    // Debug function to check Firebase configuration
    function debugFirebaseConfig() {
      console.log("Firebase app initialized:", firebase.apps.length > 0);
      console.log("Auth instance:", !!firebase.auth());
      console.log("Current domain:", window.location.hostname);
      console.log("Auth domain:", firebaseConfig.authDomain);
    }

    // Call debug function on load
    window.addEventListener('load', debugFirebaseConfig);
  </script>
</body>
</html>