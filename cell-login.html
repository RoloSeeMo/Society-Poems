<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phone Login - Society Poems</title>
    <link rel="stylesheet" href="style.css">
    <!-- Link to your image to be used as a favicon -->
    <link rel="icon" href="Images/Untitled1.png" type="image/png">
    <!-- reCAPTCHA script is required for phone auth -->
    <script src="https://www.google.com/recaptcha/api.js"></script>
</head>
<body data-theme="night" style="visibility: hidden;">
    <div class="form-page-container">
        <div class="form-container">
            <h1>Login with Phone</h1>
            <div id="message-container"></div>
            
            <!-- Using a form tag helps with semantics, but we will control submission with JS -->
            <form id="phone-login-form" onsubmit="return false;">
                <div id="phone-entry-step">
                    <label for="phone-input">Phone Number:</label>
                    <input type="tel" id="phone-input" placeholder="+1 555-555-5555" required>
                    <!-- Button type is 'button' to prevent default form validation -->
                    <button type="button" id="send-code-btn" class="form-button form-button-primary">Send Code</button>
                </div>

                <div id="otp-verify-step" style="display:none;">
                    <label for="otp-input">Verification Code:</label>
                    <!-- The 'required' attribute is removed here and will be added via JS -->
                    <input type="text" id="otp-input" inputmode="numeric" placeholder="Enter OTP">
                    <button type="button" id="verify-otp-btn" class="form-button form-button-primary">Verify Code</button>
                </div>
            </form>
             <button class="form-button" style="background: #555; color: white; margin-top: 10px;" onclick="window.location.href='login.html'">Go Back</button>
        </div>
    </div>
    <!-- This empty div is required by reCAPTCHA to function -->
    <div id="recaptcha-container"></div>

    <!-- Firebase SDKs (Compat versions for global access) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Firebase configuration object is now updated.
            const firebaseConfig = {
                apiKey: "AIzaSyDHXEMtVPn46b2qS1CPGUIEuQ8ntLyvLVM",
                authDomain: "society-poems-97f4d.firebaseapp.com",
                databaseURL: "https://society-poems-97f4d-default-rtdb.firebaseio.com",
                projectId: "society-poems-97f4d",
                storageBucket: "society-poems-97f4d.firebasestorage.app",
                messagingSenderId: "723670230106",
                appId: "1:723670230106:web:6d6dda4f8c46626c55a463"
            };

            const app = firebase.initializeApp(firebaseConfig);
            const auth = firebase.auth();
            
            const messageContainer = document.getElementById('message-container');

            function showMessage(type, text) {
                if (!messageContainer) return;
                messageContainer.className = `message-container ${type}-message`;
                messageContainer.textContent = text;
                messageContainer.style.display = 'block';
            }

            // --- Auth Check for Login Page ---
            auth.onAuthStateChanged(user => {
                if (user) {
                    window.location.href = 'index.html';
                } else {
                    document.body.style.visibility = 'visible';
                }
            });

            // --- Phone Auth Logic ---
            window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', {
                'size': 'invisible'
            });

            const sendCodeBtn = document.getElementById('send-code-btn');
            const verifyOtpBtn = document.getElementById('verify-otp-btn');
            const otpInput = document.getElementById('otp-input');

            sendCodeBtn.addEventListener('click', () => {
                // --- ROBUST FORMATTING FIX ---
                // 1. Get the raw input from the user.
                const rawPhoneNumber = document.getElementById('phone-input').value;
                // 2. Remove all non-digit characters.
                const digitsOnly = rawPhoneNumber.replace(/\D/g, '');
                // 3. Construct the E.164 format number.
                const phoneNumber = `+${digitsOnly}`;

                if (!rawPhoneNumber) {
                    showMessage('error', 'Please enter a phone number.');
                    return;
                }

                console.log(`Attempting to send code to formatted number: ${phoneNumber}`); // Debugging line

                const appVerifier = window.recaptchaVerifier;
                
                auth.signInWithPhoneNumber(phoneNumber, appVerifier)
                    .then((confirmationResult) => {
                        window.confirmationResult = confirmationResult;
                        showMessage('success', 'Verification code sent!');
                        document.getElementById('phone-entry-step').style.display = 'none';
                        document.getElementById('otp-verify-step').style.display = 'block';
                        otpInput.required = true;
                    })
                    .catch((error) => {
                        showMessage('error', `SMS sending failed: ${error.message}`);
                         window.recaptchaVerifier.render().then(function(widgetId) {
                            grecaptcha.reset(widgetId);
                        });
                    });
            });

            verifyOtpBtn.addEventListener('click', () => {
                const code = otpInput.value;
                if (!code) {
                    showMessage('error', 'Please enter the verification code.');
                    return;
                }
                if (!window.confirmationResult) {
                    showMessage('error', 'Please request a code first.');
                    return;
                }
                window.confirmationResult.confirm(code).catch((error) => {
                    showMessage('error', `Invalid code: ${error.message}`);
                });
            });
        });
    </script>
</body>
</html>
