<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Read - Society Poems</title>
    <link rel="stylesheet" href="style.css">
</head>
<body data-theme="night" style="visibility: hidden;">

    <header>
        <nav class="navbar">
            <a href="index.html" class="nav-logo">ðŸ“– Society Poems</a>
            <button id="menu-open-button" class="fas fa-bars"></button>
            <ul class="nav-menu">
                <button id="menu-close-button" class="fas fa-times"></button>
                <li><a href="index.html" class="nav-link">Home</a></li>
                <li><a href="read.html" class="nav-link active">Read</a></li>
                <li><a href="upload.html" class="nav-link">Upload</a></li>
                <li><a href="feedback.html" class="nav-link">Feedback</a></li>
                <li><a id="logoutBtn" class="nav-link">Logout</a></li>
            </ul>
        </nav>
    </header>

    <main>
        <section class="section-content">
            <h1 class="section-title">Submissions</h1>
            <div id="entriesContainer">
                <p>Loading entries...</p>
            </div>
        </section>
    </main>

    <footer>
        <p>&copy; 2025 Society Poems</p>
    </footer>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // TODO: Replace with your Firebase config.
            const firebaseConfig = {
                apiKey: "AIzaSyDHXEMtVPn46b2qS1CPGUIEuQ8ntLyvLVM",
                authDomain: "society-poems-97f4d.firebaseapp.com",
                databaseURL: "https://society-poems-97f4d-default-rtdb.firebaseio.com",
                projectId: "society-poems-97f4d",
                storageBucket: "society-poems-97f4d.firebasestorage.app",
                messagingSenderId: "723670230106",
                appId: "1:723670230106:web:6d6dda4f8c46626c55a463"
            };

            const app = firebase.initializeApp(firebaseConfig);
            const auth = firebase.auth();
            const db = firebase.database();

            // --- Admin Configuration ---
            const adminUIDs = ["SAD2VGjLrtVA80Cg0ay71rDiijQ2"];
            let currentUserIsAdmin = false;

            // --- Shared Logic ---
            const setupMobileMenu_impl = () => {
                const openBtn = document.getElementById('menu-open-button');
                const closeBtn = document.getElementById('menu-close-button');
                const navMenu = document.querySelector('.nav-menu');
                if (openBtn && closeBtn && navMenu) {
                    openBtn.addEventListener('click', () => navMenu.classList.add('active'));
                    closeBtn.addEventListener('click', () => navMenu.classList.remove('active'));
                }
            };

            const handleLogout_impl = () => {
                const logoutBtn = document.getElementById('logoutBtn');
                if (logoutBtn) {
                    logoutBtn.addEventListener('click', () => {
                        auth.signOut().catch(error => console.error('Sign out error', error));
                    });
                }
            };
            
            const checkAuthState_impl = () => {
                auth.onAuthStateChanged(user => {
                    const isAuthPage = window.location.pathname.includes('login.html');
                    if (!user && !isAuthPage) {
                        window.location.href = 'login.html';
                    } else if (user && isAuthPage) {
                        window.location.href = 'index.html';
                    } else if (user) {
                        // --- Security Check ---
                        const userRef = db.ref('users/' + user.uid);
                        userRef.once('value', (snapshot) => {
                            if (snapshot.exists() && snapshot.val().username) {
                                currentUserIsAdmin = adminUIDs.includes(user.uid);
                                document.body.style.visibility = 'visible';
                                loadEntries(); // Load entries only after verification
                            } else {
                                window.location.href = 'login.html';
                            }
                        });
                    }
                });
            };

            // --- Read Page Specific Logic ---
            const loadEntries = () => {
                const entriesContainer = document.getElementById('entriesContainer');
                const entriesRef = db.ref('uploads');

                entriesRef.on('value', (snapshot) => {
                    entriesContainer.innerHTML = ''; // Clear previous content
                    const data = snapshot.val();
                    if (!data) {
                        entriesContainer.innerHTML = '<p>No entries yet. Be the first!</p>';
                        return;
                    }

                    // --- NEW: Group entries by genre ---
                    const genres = {};
                    for (const key in data) {
                        const entry = data[key];
                        const entryGenre = entry.genre || 'Uncategorized'; // Default for old posts
                        
                        if (!genres[entryGenre]) {
                            genres[entryGenre] = [];
                        }
                        // Add the database key to the entry object for deletion
                        entry.dbKey = key; 
                        genres[entryGenre].push(entry);
                    }

                    // --- NEW: Display entries grouped by genre ---
                    for (const genreName in genres) {
                        // Create a container for the genre
                        const genreSection = document.createElement('div');
                        genreSection.className = 'genre-section';

                        // Create the title for the genre
                        const genreTitle = document.createElement('h2');
                        genreTitle.className = 'genre-title';
                        genreTitle.textContent = genreName;
                        genreSection.appendChild(genreTitle);

                        // Sort entries in this genre by timestamp (newest first)
                        const sortedEntries = genres[genreName].sort((a, b) => b.timestamp - a.timestamp);

                        // Create and append each entry to this genre's section
                        sortedEntries.forEach(entry => {
                            const div = document.createElement('div');
                            div.className = 'entry';
                            
                            const content = document.createElement('p');
                            content.className = 'entry-content';
                            content.innerText = entry.content;
                            
                            const meta = document.createElement('div');
                            meta.className = 'entry-meta';
                            const date = new Date(entry.timestamp).toLocaleString();
                            meta.innerHTML = `&mdash; <strong>${entry.name || 'Anonymous'}</strong>, <em>${date}</em>`;
                            
                            if (currentUserIsAdmin) {
                                const deleteBtn = document.createElement('button');
                                deleteBtn.className = 'delete-btn';
                                deleteBtn.innerHTML = '&times;';
                                deleteBtn.title = 'Delete this entry';
                                deleteBtn.dataset.key = entry.dbKey; // Use the stored key
                                div.appendChild(deleteBtn);
                            }

                            div.appendChild(content);
                            div.appendChild(meta);
                            genreSection.appendChild(div);
                        });

                        entriesContainer.appendChild(genreSection);
                    }
                });

                // Event listener for deletion remains the same
                entriesContainer.addEventListener('click', (e) => {
                    if (e.target && e.target.classList.contains('delete-btn')) {
                        const entryKey = e.target.dataset.key;
                        if (entryKey && confirm('Are you sure you want to permanently delete this entry?')) {
                            const entryRef = db.ref('uploads/' + entryKey);
                            entryRef.remove()
                                .then(() => console.log("Entry deleted successfully."))
                                .catch((error) => console.error("Error deleting entry:", error));
                        }
                    }
                });
            };

            // Initializing page functions
            setupMobileMenu_impl();
            handleLogout_impl();
            checkAuthState_impl();
        });
    </script>
</body>
</html>