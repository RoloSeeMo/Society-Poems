<!DOCTYPE html>
<html>
<head>
    <title>Read Entries</title>
    <style>
        body {
            visibility: hidden; /* Hide content until authentication is checked */
        }
        .entry {
            border: 1px solid #ccc;
            margin-bottom: 10px;
            padding: 10px;
        }
        #genre-filter {
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <h1>Entries</h1>

    <div id="genre-filter">
        <label for="genre-select">Filter by Genre:</label>
        <select id="genre-select">
            <option value="">All Genres</option>
            <!-- Genres will be dynamically added here -->
        </select>
    </div>

    <div id="entries-container">
        <!-- Entries will be dynamically added here -->
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <script>
        // Firebase configuration (replace with your actual config)
        const firebaseConfig = {
            apiKey: "AIzaSyDHXEMtVPn46b2qS1CPGUIEuQ8ntLyvLVM",
            authDomain: "society-poems-97f4d.firebaseapp.com",
            databaseURL: "https://society-poems-97f4d-default-rtdb.firebaseio.com",
            projectId: "society-poems-97f4d",
            storageBucket: "society-poems-97f4d.firebasestorage.app",
            messagingSenderId: "723670230106",
            appId: "1:723670230106:web:6d6dda4f8c46626c55a463"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        let currentUserIsAdmin = false;
        const adminUIDs = ["SAD2VGjLrtVA80Cg0ay71rDiijQ2"]; // Replace with actual admin UIDs

        // Function to check authentication state
        const checkAuthState = () => {
            auth.onAuthStateChanged(user => {
                if (!user) {
                    window.location.href = 'login.html';
                } else {
                    const userRef = db.ref('users/' + user.uid);
                    userRef.once('value', (snapshot) => {
                        if (snapshot.exists() && snapshot.val().username) {
                            currentUserIsAdmin = adminUIDs.includes(user.uid);
                            document.body.style.visibility = 'visible';
                            setupLiveEntriesListener(); 

                            // Check for topic parameter in URL and auto-load that topic
                            const urlParams = new URLSearchParams(window.location.search);
                            const topicParam = urlParams.get('topic');
                            if (topicParam) {
                                // Wait a moment for the data to load, then switch to the specific topic
                                setTimeout(() => {
                                    loadEntriesByGenre(topicParam);
                                }, 1500);
                            }
                        } else {
                            window.location.href = 'login.html';
                        }
                    });
                }
            });
        };

        // Function to setup live listener for entries
        function setupLiveEntriesListener() {
            const entriesContainer = document.getElementById("entries-container");
            const genreButtonsContainer = document.getElementById("genre-filter");
            let genreCounts = {};

            db.ref("entries").orderByChild("timestamp").on("value", (snapshot) => {
                    entriesContainer.innerHTML = ""; // Clear existing entries
                    genreCounts = {};

                    snapshot.forEach((childSnapshot) => {
                        const entryData = childSnapshot.val();
                        const entryId = childSnapshot.key;
                        const entryElement = createEntryElement(entryId, entryData);
                        entriesContainer.appendChild(entryElement);

                        // Count genres
                        const genre = entryData.genre;
                        genreCounts[genre] = (genreCounts[genre] || 0) + 1;

                        // Check for topic parameter in URL and auto-load that topic
                        const urlParams = new URLSearchParams(window.location.search);
                        const topicParam = urlParams.get('topic');
                    });

                    // Create genre buttons
                    genreButtonsContainer.innerHTML = '';

                    // Add sorting controls
                    const sortingControls = document.createElement('div');
                    sortingControls.className = 'sorting-controls';
                    sortingControls.style.marginBottom = '20px';
                    sortingControls.style.textAlign = 'center';

                    const sortLabel = document.createElement('span');
                    sortLabel.textContent = 'Sort by: ';
                    sortLabel.style.marginRight = '10px';

                    const alphabeticalBtn = document.createElement('button');
                    alphabeticalBtn.textContent = 'Alphabetical';
                    alphabeticalBtn.className = 'sort-btn';
                    alphabeticalBtn.onclick = () => sortGenres('alphabetical');

                    const countBtn = document.createElement('button');
                    countBtn.textContent = 'Post Count';
                    countBtn.className = 'sort-btn';
                    countBtn.onclick = () => sortGenres('count');

                    sortingControls.appendChild(sortLabel);
                    sortingControls.appendChild(alphabeticalBtn);
                    sortingControls.appendChild(countBtn);

                    // Insert sorting controls before genre buttons
                    genreButtonsContainer.parentNode.insertBefore(sortingControls, genreButtonsContainer);

                    for (const genre in genreCounts) {
                        const button = document.createElement('button');
                        button.dataset.genre = genre;
                        button.textContent = `${genre} `;
                        button.className = 'genre-button';

                        const countSpan = document.createElement('span');
                        countSpan.className = 'genre-count';
                        countSpan.textContent = `(${genreCounts[genre]})`;
                        button.appendChild(countSpan);

                        button.addEventListener('click', () => loadEntriesByGenre(genre));
                        genreButtonsContainer.appendChild(button);
                    }

                    // Auto-load topic if URL parameter exists
                    if (topicParam && genreCounts[topicParam]) {
                        setTimeout(() => {
                            loadEntriesByGenre(topicParam);
                        }, 1000);
                    }
                });
        }

        // Function to create an entry element
        function createEntryElement(docId, data) {
            const entryDiv = document.createElement("div");
            entryDiv.classList.add("entry");

            const titleElement = document.createElement("h3");
            titleElement.textContent = data.title;
            entryDiv.appendChild(titleElement);

            const genreElement = document.createElement("p");
            genreElement.textContent = `Genre: ${data.genre}`;
            entryDiv.appendChild(genreElement);

            const contentElement = document.createElement("p");
            contentElement.textContent = data.content;
            entryDiv.appendChild(contentElement);

            const authorElement = document.createElement("p");
            authorElement.textContent = `Author: ${data.author}`;
            entryDiv.appendChild(authorElement);

            const timestampElement = document.createElement("p");
            const date = data.timestamp ? new Date(data.timestamp) : new Date();
            timestampElement.textContent = `Date: ${date.toLocaleDateString()} ${date.toLocaleTimeString()}`;
            entryDiv.appendChild(timestampElement);

            if (currentUserIsAdmin) {
                const deleteButton = document.createElement("button");
                deleteButton.textContent = "Delete";
                deleteButton.addEventListener("click", () => deleteEntry(docId));
                entryDiv.appendChild(deleteButton);
            }

            return entryDiv;
        }

        // Function to delete an entry
        async function deleteEntry(docId) {
            if (confirm("Are you sure you want to delete this entry?")) {
                try {
                    await db.ref("entries").child(docId).remove();
                    console.log("Entry deleted successfully!");
                } catch (error) {
                    console.error("Error deleting entry: ", error);
                    alert("Failed to delete entry.");
                }
            }
        }

        // Function to load entries by genre
        function loadEntriesByGenre(genre) {
            db.ref("entries")
                .orderByChild("genre")
                .equalTo(genre)
                .once("value")
                .then((snapshot) => {
                    const entriesContainer = document.getElementById("entries-container");
                    entriesContainer.innerHTML = ""; // Clear existing entries

                    snapshot.forEach((childSnapshot) => {
                        const entryData = childSnapshot.val();
                        const entryId = childSnapshot.key;
                        const entryElement = createEntryElement(entryId, entryData);
                        entriesContainer.appendChild(entryElement);
                    });
                })
                .catch((error) => {
                    console.error("Error getting entries by genre: ", error);
                });
        }

        const sortGenres = (sortType) => {
            const buttons = Array.from(genreButtonsContainer.children);
            
            buttons.sort((a, b) => {
                if (sortType === 'alphabetical') {
                    return a.dataset.genre.localeCompare(b.dataset.genre);
                } else if (sortType === 'count') {
                    const countA = parseInt(a.querySelector('.genre-count').textContent.match(/\d+/)[0]);
                    const countB = parseInt(b.querySelector('.genre-count').textContent.match(/\d+/)[0]);
                    return countB - countA; // High to low
                }
            });
            
            genreButtonsContainer.innerHTML = '';
            buttons.forEach(button => genreButtonsContainer.appendChild(button));
        };

        // Function to populate genre filter options
        function populateGenreFilter() {
            const genreSelect = document.getElementById("genre-select");
            const genres = ["Fiction", "Non-Fiction", "Science Fiction", "Fantasy", "Mystery", "Thriller", "Horror", "Romance", "Historical Fiction"]; // Example genres

            genres.forEach(genre => {
                const option = document.createElement("option");
                option.value = genre;
                option.textContent = genre;
                genreSelect.appendChild(option);
            });

            genreSelect.addEventListener("change", function() {
                const selectedGenre = this.value;
                if (selectedGenre === "") {
                    setupLiveEntriesListener(); // Load all entries
                } else {
                    loadEntriesByGenre(selectedGenre);
                }
            });
        }

        // Call functions on page load
        checkAuthState();
        populateGenreFilter();
    </script>
</body>
</html>
