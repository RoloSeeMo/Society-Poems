<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Read - Society Poems</title>
    <link rel="stylesheet" href="style.css">
</head>
<body data-theme="night" style="visibility: hidden;">

    <header>
        <nav class="navbar">
            <a href="index.html" class="nav-logo">ðŸ“– Society Poems</a>
            <button id="menu-open-button" class="fas fa-bars"></button>
            <ul class="nav-menu">
                <button id="menu-close-button" class="fas fa-times"></button>
                <li><a href="index.html" class="nav-link">Home</a></li>
                <li><a href="read.html" class="nav-link active">Read</a></li>
                <li><a href="upload.html" class="nav-link">Upload</a></li>
                <li><a href="feedback.html" class="nav-link">Feedback</a></li>
                <li><a id="logoutBtn" class="nav-link">Logout</a></li>
            </ul>
        </nav>
    </header>

    <main>
        <section class="section-content">
            
            <div id="genre-selection-view">
                <h1 class="section-title">Choose a Genre</h1>
                <div id="genre-buttons-container" class="genre-buttons-container">
                    <p>Loading genres...</p>
                </div>
            </div>

            <div id="entries-view" style="display: none;">
                <div class="entries-header">
                    <button id="back-to-genres-btn" class="back-button">&larr; Back to Genres</button>
                    <h1 id="entries-view-title" class="section-title" style="margin-top: 0;"></h1>
                </div>
                <div id="entriesContainer">
                    <p>Loading entries...</p>
                </div>
            </div>

        </section>
    </main>

    <footer>
        <p>&copy; 2025 Society Poems</p>
    </footer>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const firebaseConfig = {
                apiKey: "AIzaSyDHXEMtVPn46b2qS1CPGUIEuQ8ntLyvLVM",
                authDomain: "society-poems-97f4d.firebaseapp.com",
                databaseURL: "https://society-poems-97f4d-default-rtdb.firebaseio.com",
                projectId: "society-poems-97f4d",
                storageBucket: "society-poems-97f4d.firebasestorage.app",
                messagingSenderId: "723670230106",
                appId: "1:723670230106:web:6d6dda4f8c46626c55a463"
            };

            const app = firebase.initializeApp(firebaseConfig);
            const auth = firebase.auth();
            const db = firebase.database();
            const adminUIDs = ["SAD2VGjLrtVA80Cg0ay71rDiijQ2"];
            let currentUserIsAdmin = false;
            let allEntries = null; // Cache for all entries

            // --- Views and UI Elements ---
            const genreSelectionView = document.getElementById('genre-selection-view');
            const entriesView = document.getElementById('entries-view');
            const entriesContainer = document.getElementById('entriesContainer');
            const genreButtonsContainer = document.getElementById('genre-buttons-container');
            const backToGenresBtn = document.getElementById('back-to-genres-btn');

            // --- Shared Logic ---
            const setupMobileMenu_impl = () => { /* ... same as before ... */ };
            const handleLogout_impl = () => { /* ... same as before ... */ };
            
            const checkAuthState_impl = () => {
                auth.onAuthStateChanged(user => {
                    if (!user) {
                        window.location.href = 'login.html';
                    } else {
                        const userRef = db.ref('users/' + user.uid);
                        userRef.once('value', (snapshot) => {
                            if (snapshot.exists() && snapshot.val().username) {
                                currentUserIsAdmin = adminUIDs.includes(user.uid);
                                document.body.style.visibility = 'visible';
                                fetchAllEntriesAndDisplayGenres();
                            } else {
                                window.location.href = 'login.html';
                            }
                        });
                    }
                });
            };

            // --- NEW: Step 1 - Fetch all entries once and generate genre buttons ---
            const fetchAllEntriesAndDisplayGenres = () => {
                const entriesRef = db.ref('uploads');
                entriesRef.on('value', (snapshot) => {
                    allEntries = snapshot.val(); // Store all entries in the cache
                    if (!allEntries) {
                        genreButtonsContainer.innerHTML = '<p>No submissions yet.</p>';
                        return;
                    }

                    const genres = new Set();
                    for (const key in allEntries) {
                        genres.add(allEntries[key].genre || 'Uncategorized');
                    }
                    
                    genreButtonsContainer.innerHTML = ''; // Clear loading message
                    genres.forEach(genreName => {
                        const button = document.createElement('button');
                        button.className = 'genre-button';
                        button.textContent = genreName;
                        button.dataset.genre = genreName;
                        genreButtonsContainer.appendChild(button);
                    });
                }, (error) => {
                    console.error(error);
                    genreButtonsContainer.innerHTML = '<p>Error loading genres.</p>';
                });
            };

            // --- NEW: Step 2 - Load and display entries for a specific genre ---
            const loadEntriesByGenre = (selectedGenre) => {
                genreSelectionView.style.display = 'none';
                entriesView.style.display = 'block';
                document.getElementById('entries-view-title').textContent = selectedGenre;
                entriesContainer.innerHTML = '';

                if (!allEntries) {
                    entriesContainer.innerHTML = '<p>No entries found.</p>';
                    return;
                }
                
                let entriesForGenre = Object.values(allEntries).filter(entry => (entry.genre || 'Uncategorized') === selectedGenre);
                entriesForGenre.sort((a, b) => b.timestamp - a.timestamp); // Sort newest first

                if (entriesForGenre.length === 0) {
                    entriesContainer.innerHTML = `<p>No entries found for the genre "${selectedGenre}".</p>`;
                    return;
                }

                entriesForGenre.forEach(entry => {
                    // This is where you would get the database key if you weren't caching
                    // For now, let's find the key from the cached object
                    const dbKey = Object.keys(allEntries).find(key => allEntries[key] === entry);
                    
                    const div = document.createElement('div');
                    div.className = 'entry';
                    
                    const content = document.createElement('p');
                    content.className = 'entry-content';
                    content.innerText = entry.content;
                    
                    const meta = document.createElement('div');
                    meta.className = 'entry-meta';
                    const date = new Date(entry.timestamp).toLocaleString();
                    meta.innerHTML = `&mdash; <strong>${entry.name || 'Anonymous'}</strong>, <em>${date}</em>`;
                    
                    if (currentUserIsAdmin) {
                        const deleteBtn = document.createElement('button');
                        deleteBtn.className = 'delete-btn';
                        deleteBtn.innerHTML = '&times;';
                        deleteBtn.title = 'Delete this entry';
                        deleteBtn.dataset.key = dbKey;
                        div.appendChild(deleteBtn);
                    }

                    div.appendChild(content);
                    div.appendChild(meta);
                    entriesContainer.appendChild(div);
                });
            };
            
            // --- NEW: Event Listeners for new UI ---
            genreButtonsContainer.addEventListener('click', (e) => {
                if (e.target && e.target.classList.contains('genre-button')) {
                    const genre = e.target.dataset.genre;
                    loadEntriesByGenre(genre);
                }
            });

            backToGenresBtn.addEventListener('click', () => {
                entriesView.style.display = 'none';
                genreSelectionView.style.display = 'block';
            });

            entriesContainer.addEventListener('click', (e) => {
                if (e.target && e.target.classList.contains('delete-btn')) {
                    const entryKey = e.target.dataset.key;
                    if (entryKey && confirm('Are you sure you want to permanently delete this entry?')) {
                        db.ref('uploads/' + entryKey).remove();
                    }
                }
            });

            // Re-implementing shared logic here for brevity
            setupMobileMenu_impl = () => { const openBtn = document.getElementById('menu-open-button'); const closeBtn = document.getElementById('menu-close-button'); const navMenu = document.querySelector('.nav-menu'); if (openBtn && closeBtn && navMenu) { openBtn.addEventListener('click', () => navMenu.classList.add('active')); closeBtn.addEventListener('click', () => navMenu.classList.remove('active')); } };
            handleLogout_impl = () => { const logoutBtn = document.getElementById('logoutBtn'); if (logoutBtn) { logoutBtn.addEventListener('click', () => { auth.signOut().catch(error => console.error('Sign out error', error)); }); } };

            // Initialize Page
            setupMobileMenu_impl();
            handleLogout_impl();
            checkAuthState_impl();
        });
    </script>
</body>
</html>