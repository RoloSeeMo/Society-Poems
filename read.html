<!DOCTYPE html>
<html>
<head>
    <title>Read Entries</title>
    <style>
        body {
            visibility: hidden; /* Hide content until authentication is checked */
        }
        .entry {
            border: 1px solid #ccc;
            margin-bottom: 10px;
            padding: 10px;
        }
        #genre-filter {
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <h1>Entries</h1>

    <div id="genre-filter">
        <label for="genre-select">Filter by Genre:</label>
        <select id="genre-select">
            <option value="">All Genres</option>
            <!-- Genres will be dynamically added here -->
        </select>
    </div>

    <div id="entries-container">
        <!-- Entries will be dynamically added here -->
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js"></script>

    <script>
        // Firebase configuration (replace with your actual config)
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        let currentUserIsAdmin = false;
        const adminUIDs = ["ADMIN_UID_1", "ADMIN_UID_2"]; // Replace with actual admin UIDs

        // Function to check authentication state
        const checkAuthState = () => {
            auth.onAuthStateChanged(user => {
                if (!user) {
                    window.location.href = 'login.html';
                } else {
                    const userRef = db.ref('users/' + user.uid);
                    userRef.once('value', (snapshot) => {
                        if (snapshot.exists() && snapshot.val().username) {
                            currentUserIsAdmin = adminUIDs.includes(user.uid);
                            document.body.style.visibility = 'visible';
                            setupLiveEntriesListener(); 
                    
                            // Check for topic parameter in URL and auto-load that topic
                            const urlParams = new URLSearchParams(window.location.search);
                            const topicParam = urlParams.get('topic');
                            if (topicParam) {
                                // Wait a moment for the data to load, then switch to the specific topic
                                setTimeout(() => {
                                    loadEntriesByGenre(topicParam);
                                }, 1500);
                            }
                        } else {
                            window.location.href = 'login.html';
                        }
                    });
                }
            });
        };

        // Function to setup live listener for entries
        function setupLiveEntriesListener() {
            db.collection("entries").orderBy("timestamp", "desc")
                .onSnapshot((querySnapshot) => {
                    const entriesContainer = document.getElementById("entries-container");
                    entriesContainer.innerHTML = ""; // Clear existing entries

                    querySnapshot.forEach((doc) => {
                        const entryData = doc.data();
                        const entryElement = createEntryElement(doc.id, entryData);
                        entriesContainer.appendChild(entryElement);
                    });
                });
        }

        // Function to create an entry element
        function createEntryElement(docId, data) {
            const entryDiv = document.createElement("div");
            entryDiv.classList.add("entry");

            const titleElement = document.createElement("h3");
            titleElement.textContent = data.title;
            entryDiv.appendChild(titleElement);

            const genreElement = document.createElement("p");
            genreElement.textContent = `Genre: ${data.genre}`;
            entryDiv.appendChild(genreElement);

            const contentElement = document.createElement("p");
            contentElement.textContent = data.content;
            entryDiv.appendChild(contentElement);

            const authorElement = document.createElement("p");
            authorElement.textContent = `Author: ${data.author}`;
            entryDiv.appendChild(authorElement);

            const timestampElement = document.createElement("p");
            const date = data.timestamp ? new Date(data.timestamp.seconds * 1000) : new Date();
            timestampElement.textContent = `Date: ${date.toLocaleDateString()} ${date.toLocaleTimeString()}`;
            entryDiv.appendChild(timestampElement);

            if (currentUserIsAdmin) {
                const deleteButton = document.createElement("button");
                deleteButton.textContent = "Delete";
                deleteButton.addEventListener("click", () => deleteEntry(docId));
                entryDiv.appendChild(deleteButton);
            }

            return entryDiv;
        }

        // Function to delete an entry
        async function deleteEntry(docId) {
            if (confirm("Are you sure you want to delete this entry?")) {
                try {
                    await db.collection("entries").doc(docId).delete();
                    console.log("Entry deleted successfully!");
                } catch (error) {
                    console.error("Error deleting entry: ", error);
                    alert("Failed to delete entry.");
                }
            }
        }

        // Function to load entries by genre
        function loadEntriesByGenre(genre) {
            db.collection("entries")
                .where("genre", "==", genre)
                .orderBy("timestamp", "desc")
                .get()
                .then((querySnapshot) => {
                    const entriesContainer = document.getElementById("entries-container");
                    entriesContainer.innerHTML = ""; // Clear existing entries

                    querySnapshot.forEach((doc) => {
                        const entryData = doc.data();
                        const entryElement = createEntryElement(doc.id, entryData);
                        entriesContainer.appendChild(entryElement);
                    });
                })
                .catch((error) => {
                    console.error("Error getting entries by genre: ", error);
                });
        }

        // Function to populate genre filter options
        function populateGenreFilter() {
            const genreSelect = document.getElementById("genre-select");
            const genres = ["Fiction", "Non-Fiction", "Science Fiction", "Fantasy", "Mystery", "Thriller", "Horror", "Romance", "Historical Fiction"]; // Example genres

            genres.forEach(genre => {
                const option = document.createElement("option");
                option.value = genre;
                option.textContent = genre;
                genreSelect.appendChild(option);
            });

            genreSelect.addEventListener("change", function() {
                const selectedGenre = this.value;
                if (selectedGenre === "") {
                    setupLiveEntriesListener(); // Load all entries
                } else {
                    loadEntriesByGenre(selectedGenre);
                }
            });
        }

        // Call functions on page load
        checkAuthState();
        populateGenreFilter();
    </script>
</body>
</html>
