<!DOCTYPE html>
<html>
<head>
    <title>Read Entries</title>
    <link rel="icon" href="/Images/Untitled1.png">
    <link rel="stylesheet" href="style.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body data-theme="night" style="visibility: hidden;">

    <header>
        <nav class="navbar">
            <a href="index.html" class="nav-logo">üìñ Society Poems</a>
            <button id="menu-open-button" class="fas fa-bars"></button>
            <ul class="nav-menu">
                <button id="menu-close-button" class="fas fa-times"></button>
                <li><a href="index.html" class="nav-link">Home</a></li>
                <li><a href="read.html" class="nav-link active">Read</a></li>
                <li><a href="upload.html" class="nav-link auth-required">Upload</a></li>
                <li><a href="livechat.html" class="nav-link">Live Chat</a></li>
                <li><a href="feedback.html" class="nav-link auth-required">Feedback</a></li>
                <li><a id="logoutBtn" class="nav-link">Login</a></li>
            </ul>
        </nav>
    </header>

    <main>
        <section class="section-content">
            
            <div id="genre-selection-view">
                <div class="genre-header">
                    <h1 class="section-title">Choose a Topic</h1>
                    <div id="sorting-controls" class="sorting-controls-header" style="display: none;">
                        <button id="alphabetical-sort-btn" class="sort-button">A-Z</button>
                        <button id="count-sort-btn" class="sort-button">Posts ‚Üì</button>
                    </div>
                </div>
                <div id="genre-buttons-container" class="genre-buttons-container">
                    <p>Loading genres...</p>
                </div>
            </div>

            <div id="entries-view" style="display: none;">
                <div class="entries-header">
                    <button id="back-to-genres-btn" class="back-button">&larr; Back to Genres</button>
                    <h1 id="entries-view-title" class="section-title" style="margin-top: 0;"></h1>
                </div>
                <div id="entriesContainer">
                    <p>Loading entries...</p>
                </div>
            </div>

            <div id="user-posts-view" style="display: none;">
                <div class="entries-header">
                    <button id="back-from-user-posts-btn" class="back-button">&larr; Back</button>
                    <h1 id="user-posts-title" class="section-title" style="margin-top: 0;"></h1>
                </div>
                <div class="user-profile-info">
                    <div class="user-avatar-large" id="user-profile-avatar">?</div>
                    <div class="user-profile-details">
                        <h2 id="user-profile-name">Loading...</h2>
                        <p id="user-profile-stats">Loading stats...</p>
                        <p id="user-profile-joined">Member since: Loading...</p>
                    </div>
                </div>
                <div id="user-posts-container">
                    <p>Loading user posts...</p>
                </div>
            </div>

        </section>
    </main>

    <footer>
        <p>&copy; 2025 Society Poems</p>
        <div class="footer-links">
            <a href="privacy-policy.html">Privacy Policy</a>
            <span>|</span>
            <a href="tos.html">Terms of Service</a>
        </div>
    </footer>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="shared-auth-utils.js"></script>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDHXEMtVPn46b2qS1CPGUIEuQ8ntLyvLVM",
            authDomain: "society-poems-97f4d.firebaseapp.com",
            databaseURL: "https://society-poems-97f4d-default-rtdb.firebaseio.com",
            projectId: "society-poems-97f4d",
            storageBucket: "society-poems-97f4d.firebasestorage.app",
            messagingSenderId: "723670230106",
            appId: "1:723670230106:web:6d6dda4f8c46626c55a463"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        let currentUserUID = null;
        let currentUserIsAdmin = false;

        // Initialize authentication with read-only support
        AuthUtils.initReadOnlyAuth(firebase, auth, db, {
            requireAuth: false, // Allow guests to read
            showReadOnlyMessage: true,
            onAuthSuccess: (user, userData) => {
                currentUserUID = user.uid;
                currentUserIsAdmin = AuthUtils.isAdmin();
                console.log('User authenticated:', userData.username);
            },
            onAuthFailure: () => {
                console.log('User not authenticated - showing read-only mode');
                currentUserUID = null;
                currentUserIsAdmin = false;
            }
        }).then(() => {
            // Initialize page functionality after auth check
            setupLiveEntriesListener();
            setupMobileMenu();
            setupBackButton();
            setupUserProfileNavigation();
            
            // Check for topic parameter in URL and auto-load that topic
            const urlParams = new URLSearchParams(window.location.search);
            const topicParam = urlParams.get('topic');
            if (topicParam) {
                setTimeout(() => {
                    loadEntriesByGenre(topicParam);
                }, 1500);
            }
        });

        // Modified delete entry function to check authentication
        function createEntryElement(docId, data, selectedGenre) {
            const div = document.createElement('div');
            div.className = 'entry clickable-post';
            div.dataset.postId = docId;
            div.dataset.topic = selectedGenre;
            
            // Add click handler to navigate to post detail page
            div.addEventListener('click', (e) => {
                if (e.target.classList.contains('delete-btn') || e.target.classList.contains('clickable-author')) {
                    return;
                }
                window.location.href = `post.html?topic=${encodeURIComponent(selectedGenre)}&postId=${encodeURIComponent(docId)}`;
            });
            
            const content = document.createElement('p');
            content.className = 'entry-content';
            content.innerText = data.content;
            
            const meta = document.createElement('div');
            meta.className = 'entry-meta';
            const date = new Date(data.timestamp).toLocaleString();
            meta.innerHTML = `&mdash; <strong class="clickable-author" data-author-uid="${data.uid}" data-author-name="${data.name || 'Anonymous'}">${data.name || 'Anonymous'}</strong>, <em>${date}</em>`;
            
            // Add interaction stats
            const statsDiv = document.createElement('div');
            statsDiv.className = 'post-stats';
            statsDiv.innerHTML = `
                <span class="stat-item">üí¨ <span class="comment-count">0</span></span>
                <span class="stat-item">‚ù§Ô∏è <span class="like-count">0</span></span>
                <span class="click-hint">Click to view details</span>
            `;
            
            // Show delete button only if user is authenticated AND owns the post OR is admin
            const canDelete = AuthUtils.canWrite() && ((data.uid && data.uid === currentUserUID) || currentUserIsAdmin);
            
            if (canDelete) {
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-btn';
                deleteBtn.innerHTML = '&times;';
                deleteBtn.title = data.uid === currentUserUID ? 'Delete your post' : 'Delete this entry (Admin)';
                
                deleteBtn.onclick = (e) => {
                    e.stopPropagation();
                    const confirmMessage = data.uid === currentUserUID 
                        ? 'Are you sure you want to delete your post?' 
                        : 'Are you sure you want to permanently delete this entry? (Admin action)';
                        
                    if (confirm(confirmMessage)) {
                        deleteEntryFromTopic(data, docId, selectedGenre);
                    }
                };
                div.appendChild(deleteBtn);
            }

            div.appendChild(content);
            div.appendChild(meta);
            div.appendChild(statsDiv);
            
            // Load stats for this post
            loadPostStats(docId, selectedGenre);
            
            return div;
        }

        // Rest of your existing functions remain the same, but update them to use AuthUtils.canWrite()
        // for any write operations and currentUserUID for user checks

        // [Include all your existing functions here - setupLiveEntriesListener, loadEntriesByGenre, etc.]
        // Just make sure to replace direct auth checks with AuthUtils methods

        function setupLiveEntriesListener() {
            const genreButtonsContainer = document.getElementById("genre-buttons-container");
            let genreCounts = {};

            db.ref("uploads").on("value", (snapshot) => {
                console.log("Database snapshot received:", snapshot.exists());
                genreCounts = {};
                
                if (snapshot.exists()) {
                    snapshot.forEach((topicSnapshot) => {
                        const topicName = topicSnapshot.key;
                        const postsCount = topicSnapshot.numChildren();
                        genreCounts[topicName] = postsCount;
                        console.log(`Found topic: ${topicName} with ${postsCount} posts`);
                    });
                } else {
                    console.log("No data found in uploads");
                }

                genreButtonsContainer.innerHTML = '';

                if (Object.keys(genreCounts).length > 0) {
                    const sortingControls = document.getElementById('sorting-controls');
                    sortingControls.style.display = 'flex';
                    
                    for (const genre in genreCounts) {
                        const button = document.createElement('button');
                        button.dataset.genre = genre;
                        button.textContent = `${genre} `;
                        button.className = 'genre-button';

                        const countSpan = document.createElement('span');
                        countSpan.className = 'genre-count';
                        countSpan.textContent = `Posts: ${genreCounts[genre]}`;
                        button.appendChild(countSpan);

                        button.addEventListener('click', () => loadEntriesByGenre(genre));
                        genreButtonsContainer.appendChild(button);
                    }
                    
                    setupSortingButtons(genreButtonsContainer);
                } else {
                    genreButtonsContainer.innerHTML = '<p>No submissions yet.</p>';
                    const sortingControls = document.getElementById('sorting-controls');
                    sortingControls.style.display = 'none';
                }

                const urlParams = new URLSearchParams(window.location.search);
                const topicParam = urlParams.get('topic');
                if (topicParam && genreCounts[topicParam]) {
                    setTimeout(() => {
                        loadEntriesByGenre(topicParam);
                    }, 1000);
                }
            }, (error) => {
                console.error("Database error:", error);
                genreButtonsContainer.innerHTML = '<p>Error loading topics. Please refresh the page.</p>';
            });
        }

        // Add your other existing functions here...
        // [All the other functions from your original read.html]

        const setupMobileMenu = () => {
            const openBtn = document.getElementById('menu-open-button');
            const closeBtn = document.getElementById('menu-close-button');
            const navMenu = document.querySelector('.nav-menu');
            if (openBtn && closeBtn && navMenu) {
                openBtn.addEventListener('click', () => navMenu.classList.add('active'));
                closeBtn.addEventListener('click', () => navMenu.classList.remove('active'));
            }
        };

        const setupBackButton = () => {
            const backToGenresBtn = document.getElementById('back-to-genres-btn');
            if (backToGenresBtn) {
                backToGenresBtn.addEventListener('click', () => {
                    document.getElementById('entries-view').style.display = 'none';
                    document.getElementById('genre-selection-view').style.display = 'block';
                });
            }
        };

        function setupUserProfileNavigation() {
            const backFromUserPostsBtn = document.getElementById('back-from-user-posts-btn');
            if (backFromUserPostsBtn) {
                backFromUserPostsBtn.addEventListener('click', () => {
                    const userPostsView = document.getElementById('user-posts-view');
                    const genreSelectionView = document.getElementById('genre-selection-view');
                    const entriesView = document.getElementById('entries-view');
                    
                    userPostsView.style.display = 'none';
                    
                    if (entriesView.style.display === 'block' || document.getElementById('entries-view-title').textContent) {
                        entriesView.style.display = 'block';
                    } else {
                        genreSelectionView.style.display = 'block';
                    }
                });
            }
            
            document.addEventListener('click', (e) => {
                if (e.target.classList.contains('clickable-author')) {
                    e.stopPropagation();
                    const authorUID = e.target.dataset.authorUid;
                    const authorName = e.target.dataset.authorName;
                    
                    if (authorUID && authorName && authorUID !== 'undefined') {
                        loadUserPosts(authorUID, authorName);
                    }
                }
            });
        }

        function loadPostStats(postId, topic) {
            const interactionsRef = db.ref(`interactions/${topic}/${postId}`);
            
            interactionsRef.child('comments').on('value', (snapshot) => {
                const commentCount = snapshot.exists() ? snapshot.numChildren() : 0;
                const commentCountEl = document.querySelector(`[data-post-id="${postId}"] .comment-count`);
                if (commentCountEl) {
                    commentCountEl.textContent = commentCount;
                }
            });
            
            interactionsRef.child('likes').on('value', (snapshot) => {
                const likeCount = snapshot.exists() ? snapshot.numChildren() : 0;
                const likeCountEl = document.querySelector(`[data-post-id="${postId}"] .like-count`);
                if (likeCountEl) {
                    likeCountEl.textContent = likeCount;
                }
            });
        }
    </script>
</body>
</html>
