<!DOCTYPE html>
<html>
<head>
    <title>Live Chat Rooms - Society Poems</title>
    <link rel="icon" href="/Images/Untitled1.png">
    <link rel="stylesheet" href="style.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body data-theme="night" style="visibility: hidden;">

    <header>
        <nav class="navbar">
            <a href="index.html" class="nav-logo">ðŸ“– Society Poems</a>
            <button id="menu-open-button" class="fas fa-bars"></button>
            <ul class="nav-menu">
                <button id="menu-close-button" class="fas fa-times"></button>
                <li><a href="index.html" class="nav-link">Home</a></li>
                <li><a href="read.html" class="nav-link">Read</a></li>
                <li><a href="upload.html" class="nav-link auth-required">Upload</a></li>
                <li><a href="livechat.html" class="nav-link active">Live Chat</a></li>
                <li><a href="feedback.html" class="nav-link auth-required">Feedback</a></li>
                <li><a id="logoutBtn" class="nav-link">Login</a></li>
            </ul>
        </nav>
    </header>

    <main>
        <div class="chat-container">
            <!-- Chat Rooms List View -->
            <div id="chat-rooms-view" class="chat-rooms-view">
                <div class="chat-header">
                    <h1 class="section-title">Live Chat Rooms</h1>
                    <div class="chat-stats">
                        <span id="active-rooms-count">0</span> active rooms â€¢ 
                        <span id="total-users-count">0</span> users online
                    </div>
                </div>

                <div id="message-container" class="message-container" style="display: none;"></div>

                <!-- Guest message for chat -->
                <div id="guest-chat-message" class="guest-only" style="display: none;">
                    <div style="background: var(--bg-secondary); padding: 20px; border-radius: 8px; margin-bottom: 20px; text-align: center; border-left: 4px solid var(--primary-color);">
                        <h3 style="margin-top: 0; color: var(--text-primary);">ðŸ‘‹ Welcome to Live Chat!</h3>
                        <p style="color: var(--text-secondary); margin-bottom: 15px;">
                            You can browse active chat rooms, but you'll need to <a href="login.html" style="color: var(--primary-color);">sign in</a> to join conversations and create new rooms.
                        </p>
                    </div>
                </div>

                <div class="chat-rooms-grid" id="chat-rooms-grid">
                    <div class="loading-placeholder">
                        <div class="loading-spinner"></div>
                        <p>Loading chat rooms...</p>
                    </div>
                </div>

                <div class="empty-state" id="empty-state" style="display: none;">
                    <div class="empty-icon">ðŸ’¬</div>
                    <h3>No active chat rooms</h3>
                    <p class="auth-required">Be the first to start a conversation! Click the "New Live Chat" button to create a chat room.</p>
                    <p class="guest-only">No active conversations right now. <a href="login.html">Sign in</a> to start a new chat room!</p>
                </div>
            </div>

            <!-- Individual Chat Room View -->
            <div id="chat-room-view" class="chat-room-view" style="display: none;">
                <div class="chat-room-header">
                    <button id="back-to-rooms-btn" class="back-button">&larr; Back to Rooms</button>
                    <div class="chat-room-info">
                        <h2 id="current-room-topic">Loading...</h2>
                        <div class="room-stats">
                            <span id="room-users-count">0</span> users â€¢ 
                            Created by <span id="room-creator">Unknown</span>
                        </div>
                    </div>
                    <button id="leave-room-btn" class="leave-room-btn auth-required">Leave Room</button>
                </div>

                <div class="chat-messages-container">
                    <div id="chat-messages" class="chat-messages">
                        <div class="welcome-message">
                            <p>Welcome to the chat room! <span class="auth-required">Start the conversation...</span><span class="guest-only"><a href="login.html">Sign in</a> to join the conversation!</span></p>
                        </div>
                    </div>
                </div>

                <div class="chat-input-container auth-required">
                    <div class="chat-input-wrapper">
                        <input type="text" id="chat-message-input" placeholder="Type your message..." maxlength="500">
                        <button id="send-message-btn" class="send-message-btn">
                            <span>Send</span>
                        </button>
                    </div>
                    <div class="chat-input-info">
                        <span id="typing-indicator" class="typing-indicator" style="display: none;"></span>
                        <span class="char-count"><span id="char-count">0</span>/500</span>
                    </div>
                </div>

                <!-- Guest input message -->
                <div class="guest-only" style="padding: 20px; text-align: center; background: var(--bg-secondary); border-top: 1px solid var(--border-color);">
                    <p style="margin: 0; color: var(--text-secondary);">
                        <a href="login.html" style="color: var(--primary-color); text-decoration: none; font-weight: 600;">Sign in</a> to participate in this conversation
                    </p>
                </div>
            </div>
        </div>

        <!-- Floating New Chat Button (only for authenticated users) -->
        <button id="new-chat-btn" class="floating-new-chat-btn auth-required">
            <span class="btn-icon">+</span>
            <span class="btn-text">New Live Chat</span>
        </button>
    </main>

    <!-- Rest of your existing modal and footer code... -->

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="shared-auth-utils.js"></script>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDHXEMtVPn46b2qS1CPGUIEuQ8ntLyvLVM",
            authDomain: "society-poems-97f4d.firebaseapp.com",
            databaseURL: "https://society-poems-97f4d-default-rtdb.firebaseio.com",
            projectId: "society-poems-97f4d",
            storageBucket: "society-poems-97f4d.firebasestorage.app",
            messagingSenderId: "723670230106",
            appId: "1:723670230106:web:6d6dda4f8c46626c55a463"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        let currentUserUID = null;
        let currentUsername = null;
        let currentUserIsAdmin = false;
        let currentChatRoom = null;

        // Initialize authentication with read-only support
        AuthUtils.initReadOnlyAuth(firebase, auth, db, {
            requireAuth: false, // Allow guests to view chat rooms
            showReadOnlyMessage: false, // We'll show our own chat-specific message
            onAuthSuccess: (user, userData) => {
                currentUserUID = user.uid;
                currentUsername = userData.username;
                currentUserIsAdmin = AuthUtils.isAdmin();
                console.log('User authenticated for chat:', userData.username);
            },
            onAuthFailure: () => {
                console.log('User not authenticated - showing read-only chat mode');
                currentUserUID = null;
                currentUsername = null;
                currentUserIsAdmin = false;
                
                // Show guest message
                const guestMessage = document.getElementById('guest-chat-message');
                if (guestMessage) {
                    guestMessage.style.display = 'block';
                }
            }
        }).then(() => {
            // Initialize chat functionality
            initializeChatRooms();
            setupEventListeners();
        });

        // Modified joinChatRoom function to handle guests
        function joinChatRoom(roomId, topic) {
            if (!AuthUtils.canWrite()) {
                // Guest user - show read-only view
                showMessage('info', 'Sign in to participate in chat rooms. You can view messages but cannot send them.');
                showChatRoomReadOnly(roomId, topic);
                return;
            }

            // Authenticated user - full functionality
            currentChatRoom = roomId;
            
            const userRef = db.ref(`chatRooms/${roomId}/activeUsers/${currentUserUID}`);
            userRef.set({
                username: currentUsername,
                joinedAt: firebase.database.ServerValue.TIMESTAMP
            });
            
            document.getElementById('chat-rooms-view').style.display = 'none';
            document.getElementById('chat-room-view').style.display = 'block';
            document.getElementById('current-room-topic').textContent = topic;
            
            loadChatRoomData(roomId);
            setupMessageListener(roomId);
            setupUsersListener(roomId);
            
            const messageInput = document.getElementById('chat-message-input');
            if (messageInput) {
                messageInput.focus();
            }
        }

        // New function for read-only chat room view
        function showChatRoomReadOnly(roomId, topic) {
            document.getElementById('chat-rooms-view').style.display = 'none';
            document.getElementById('chat-room-view').style.display = 'block';
            document.getElementById('current-room-topic').textContent = topic;
            
            loadChatRoomData(roomId);
            setupMessageListener(roomId);
            setupUsersListener(roomId);
        }

        // Rest of your existing chat functions...
        // [Include all your existing chat functions but modify them to check AuthUtils.canWrite()]

        function showMessage(type, text) {
            const messageContainer = document.getElementById('message-container');
            messageContainer.className = `message-container ${type}-message`;
            messageContainer.textContent = text;
            messageContainer.style.display = 'block';
            setTimeout(() => {
                messageContainer.style.display = 'none';
            }, 5000);
        }

        // [Include all your other existing functions...]
    </script>
</body>
</html>
