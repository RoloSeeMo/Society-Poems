<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload - Society Poems</title>
    <link rel="stylesheet" href="style.css">
</head>
<body data-theme="night" style="visibility: hidden;">

    <header>
        <nav class="navbar">
            <a href="index.html" class="nav-logo">üìñ Society Poems</a>
            <button id="menu-open-button" class="fas fa-bars"></button>
            <ul class="nav-menu">
                <button id="menu-close-button" class="fas fa-times"></button>
                <li><a href="index.html" class="nav-link">Home</a></li>
                <li><a href="read.html" class="nav-link">Read</a></li>
                <li><a href="upload.html" class="nav-link active">Upload</a></li>
                <li><a href="feedback.html" class="nav-link">Feedback</a></li>
                <li><a id="logoutBtn" class="nav-link">Logout</a></li>
            </ul>
        </nav>
    </header>

    <main>
        <div class="form-container" style="margin: auto;">
            <h1>‚úçÔ∏è Upload Your Writing</h1>
            <div id="message-container"></div>
            <form id="uploadForm">
                <label for="privacy">Privacy:</label>
                <select id="privacy" required>
                    <option value="" disabled selected>-- Select --</option>
                    <option value="anonymous">Anonymous</option>
                    <option value="named">Named</option>
                </select>
                
                <!-- This field is dynamically controlled by the script below -->
                <div id="nameField" style="display:none;">
                    <label for="username">Your Name:</label>
                    <input type="text" id="username" maxlength="25" placeholder="e.g. Maya Angelou">
                    <!-- This note appears for Google/Email users -->
                    <p id="auto-name-note" style="font-size: 0.8rem; color: var(--gray-color); display: none; margin-top: -15px; margin-bottom: 15px;">
                        Your display name is used automatically.
                    </p>
                </div>
                
                <label for="content">Your Writing:</label>
                <textarea id="content" rows="10" placeholder="Let your soul speak..." required></textarea>
                <button type="submit" class="form-button form-button-primary">Submit</button>
            </form>
        </div>
    </main>

    <footer>
        <p>&copy; 2025 Society Poems</p>
    </footer>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // TODO: Replace with your Firebase config.
            const firebaseConfig = {
                apiKey: "AIzaSyDHXEMtVPn46b2qS1CPGUIEuQ8ntLyvLVM",
                authDomain: "society-poems-97f4d.firebaseapp.com",
                databaseURL: "https://society-poems-97f4d-default-rtdb.firebaseio.com",
                projectId: "society-poems-97f4d",
                storageBucket: "society-poems-97f4d.firebasestorage.app",
                messagingSenderId: "723670230106",
                appId: "1:723670230106:web:6d6dda4f8c46626c55a463"
        };

            const app = firebase.initializeApp(firebaseConfig);
            const auth = firebase.auth();
            const db = firebase.database();
            
            // --- Shared Logic (implementation copied for self-containment) ---
             const setupMobileMenu_impl = () => {
                const openBtn = document.getElementById('menu-open-button');
                const closeBtn = document.getElementById('menu-close-button');
                const navMenu = document.querySelector('.nav-menu');
                if (openBtn && closeBtn && navMenu) {
                    openBtn.addEventListener('click', () => navMenu.classList.add('active'));
                    closeBtn.addEventListener('click', () => navMenu.classList.remove('active'));
                }
            };

            const handleLogout_impl = () => {
                const logoutBtn = document.getElementById('logoutBtn');
                if (logoutBtn) {
                    logoutBtn.addEventListener('click', () => {
                        auth.signOut().catch(error => console.error('Sign out error', error));
                    });
                }
            };
            
            const checkAuthState_impl = () => {
                auth.onAuthStateChanged(user => {
                    const isAuthPage = window.location.pathname.includes('login.html') || window.location.pathname.includes('cell-login.html');
                    if (!user && !isAuthPage) {
                        window.location.href = 'login.html';
                    } else if (user && isAuthPage) {
                        window.location.href = 'index.html';
                    } else {
                        document.body.style.visibility = 'visible';
                    }
                });
            };

            // --- Upload Page Specific Logic ---
            const setupUploadForm = () => {
                const uploadForm = document.getElementById('uploadForm');
                const privacySelect = document.getElementById('privacy');
                const nameField = document.getElementById('nameField');
                const usernameInput = document.getElementById('username');
                const autoNameNote = document.getElementById('auto-name-note');
                const messageContainer = document.getElementById('message-container');

                // --- NEW LOGIC: This event listener handles the dynamic name field ---
                privacySelect.addEventListener('change', () => {
                    const user = auth.currentUser;
                    if (privacySelect.value === 'named' && user) {
                        // Check if the user's primary login method is phone
                        const isPhoneUser = user.providerData.some(provider => provider.providerId === 'phone');

                        if (isPhoneUser) {
                            // Phone User: Prompt for manual name entry
                            nameField.style.display = 'block';
                            usernameInput.value = ''; // Clear any previous value
                            usernameInput.disabled = false;
                            autoNameNote.style.display = 'none';
                        } else {
                            // Email or Google User: Auto-populate their name
                            nameField.style.display = 'block';
                            let autoName = user.displayName || (user.email ? user.email.split('@')[0] : 'User');
                            usernameInput.value = autoName;
                            usernameInput.disabled = true; // Prevent user from editing
                            autoNameNote.style.display = 'block';
                        }
                    } else {
                        // "Anonymous" or no user: Hide the field
                        nameField.style.display = 'none';
                    }
                });

                uploadForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const user = auth.currentUser;
                    if (!user) {
                        showMessage('error', 'You must be logged in.'); return;
                    }
                    const content = document.getElementById('content').value.trim();
                    if (!content) {
                         showMessage('error', 'Content cannot be empty.'); return;
                    }

                    // --- NEW LOGIC: Determine the name based on the selection ---
                    let name;
                    if (privacySelect.value === 'named') {
                        // The value will either be auto-populated (and disabled) or entered by a phone user.
                        name = usernameInput.value.trim();
                        if (!name) {
                            showMessage('error', 'Please enter a name.'); return;
                        }
                    } else {
                        name = 'Anonymous';
                    }

                    const uploadsRef = db.ref('uploads');
                    
                    uploadsRef.push({
                        uid: user.uid,
                        content: content,
                        name: name,
                        timestamp: firebase.database.ServerValue.TIMESTAMP
                    }).then(() => {
                        showMessage('success', 'Submitted successfully!');
                        uploadForm.reset();
                        nameField.style.display = 'none';
                    }).catch(error => {
                        showMessage('error', `Submission failed: ${error.message}`);
                    });
                });
                
                function showMessage(type, text) {
                    if (!messageContainer) return;
                    messageContainer.className = `message-container ${type}-message`;
                    messageContainer.textContent = text;
                    messageContainer.style.display = 'block';
                }
            };

            // Initialize all page functions
            setupMobileMenu_impl();
            handleLogout_impl();
            checkAuthState_impl();
            setupUploadForm();
        });
    </script>
</body>
</html>
