<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Feedback - Society Poems</title>
    <link rel="stylesheet" href="style.css">
    <link rel="icon" href="/Images/Untitled1.png">

    <script>
        // --- IMPORTANT CONFIGURATION ---
        const CLIENT_ID = '723670230106-h7lidt5s4psj74p83m0cl0ri98532492.apps.googleusercontent.com';
        const API_KEY = 'AIzaSyDHXEMtVPn46b2qS1CPGUIEuQ8ntLyvLVM';
        const TO_EMAIL = 'officialsocietypoems@gmail.com';
    
        // --- Firebase Config ---
        const firebaseConfig = {
            apiKey: API_KEY,
            authDomain: "society-poems-97f4d.firebaseapp.com",
            databaseURL: "https://society-poems-97f4d-default-rtdb.firebaseio.com",
            projectId: "society-poems-97f4d",
            storageBucket: "society-poems-97f4d.firebasestorage.app",
            messagingSenderId: "723670230106",
            appId: "1:723670230106:web:6d6dda4f8c46626c55a463"
        };
        
        let app, auth, db, tokenClient;

        function showMessage(type, text) {
            const messageContainer = document.getElementById('message-container');
            if (!messageContainer) return;
            messageContainer.className = `message-container ${type}-message`;
            messageContainer.textContent = text;
            messageContainer.style.display = 'block';
        }

        // --- GOOGLE API CLIENT LOGIC ---
        function gapiLoaded() {
            gapi.load('client', initializeGapiClient);
        }

        async function initializeGapiClient() {
            await gapi.client.init({
                apiKey: API_KEY,
                discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/gmail/v1/rest"],
            });
        }

        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                // ADDED a new scope to ask for user's email and profile info
                scope: 'https://www.googleapis.com/auth/gmail.send https://www.googleapis.com/auth/userinfo.email https://www.googleapis.com/auth/userinfo.profile',
                callback: '',
            });
        }

        function handleFormSubmit(e) {
            e.preventDefault();
            tokenClient.callback = async (resp) => {
                if (resp.error !== undefined) { throw (resp); }
                // After successful authorization, call the function to send the email
                await sendEmailWithUserInfo();
            };

            // Ask for authorization
            if (gapi.client.getToken() === null) {
                tokenClient.requestAccessToken({prompt: 'consent'});
            } else {
                tokenClient.requestAccessToken({prompt: ''});
            }
        }

        async function sendEmailWithUserInfo() {
            showMessage('info', 'Fetching user info...');
            try {
                // 1. Get the user's profile info from Google
                const userInfoResponse = await gapi.client.request({
                    'path': 'https://www.googleapis.com/oauth2/v3/userinfo'
                });

                const profile = userInfoResponse.result;
                const name = profile.name;
                const fromEmail = profile.email;
                const message = document.getElementById('message').value;

                showMessage('info', 'Sending email...');

                // 2. Construct the email with the fetched info
                const emailLines = [
                    'Content-Type: text/plain; charset="UTF-8"',
                    `To: ${TO_EMAIL}`,
                    `From: "${name}" <${fromEmail}>`, // Use name and email
                    `Subject: New Feedback from ${name}`, // Use name
                    '',
                    message
                ].join('\r\n');

                const base64EncodedEmail = btoa(unescape(encodeURIComponent(emailLines)));

                // 3. Send the email using the Gmail API
                await gapi.client.gmail.users.messages.send({
                    'userId': 'me',
                    'resource': { 'raw': base64EncodedEmail }
                });
                
                showMessage('success', 'Thank you! Your feedback has been sent.');
                document.getElementById('feedbackForm').reset();
            } catch (error) {
                console.error(error);
                showMessage('error', `An error occurred. Please try again.`);
            }
        }
        
        // --- SHARED PAGE LOGIC ---
        document.addEventListener('DOMContentLoaded', () => {
            app = firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();

            const handleLogout_impl = () => {
                const logoutBtn = document.getElementById('logoutBtn');
                if (logoutBtn) {
                    logoutBtn.addEventListener('click', () => {
                        auth.signOut().then(() => {
                            window.location.href = 'index.html';
                        }).catch(error => console.error('Sign out error', error));
                    });
                }
            };
            
            const checkAuthState_impl = () => {
                auth.onAuthStateChanged(user => {
                    if (!user) {
                        window.location.href = 'login.html';
                    } else {
                        document.body.style.visibility = 'visible';
                    }
                });
            };

            handleLogout_impl();
            checkAuthState_impl();
            document.getElementById('feedbackForm').addEventListener('submit', handleFormSubmit);
        });
    </script>
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
</head>
<body data-theme="night" style="visibility: hidden;">

    <header>
        <nav class="navbar">
            <a href="index.html" class="nav-logo">ðŸ“– Society Poems</a>
            </nav>
    </header>

    <main>
        <div class="form-container" style="margin: auto;">
            <h1>Feedback Form</h1>
            <p style="text-align: center; font-size: 0.9em; opacity: 0.8;">
                You will be asked to authorize with your Google account to send your feedback.
            </p>
            <div id="message-container"></div>
            <form id="feedbackForm">
                <label for="message">Message:</label>
                <textarea id="message" rows="5" required></textarea>
                <button type="submit" class="form-button form-button-primary">Authorize & Send Feedback</button>
            </form>
        </div>
    </main>

    <footer>
        <p>&copy; 2025 Society Poems</p>
    </footer>

</body>
</html>