<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Feedback - Society Poems</title>
    <link rel="stylesheet" href="style.css">
    <link rel="icon" href="/Images/Untitled1.png">

    <script>
        // --- IMPORTANT CONFIGURATION ---
        const CLIENT_ID = '723670230106-h7lidt5s4psj74p83m0cl0ri98532492.apps.googleusercontent.com';
        const API_KEY = 'AIzaSyDHXEMtVPn46b2qS1CPGUIEuQ8ntLyvLVM';
        const TO_EMAIL = 'officialsocietypoems@gmail.com';
    
        // --- Firebase Config ---
        const firebaseConfig = {
            apiKey: API_KEY,
            authDomain: "society-poems-97f4d.firebaseapp.com",
            databaseURL: "https://society-poems-97f4d-default-rtdb.firebaseio.com",
            projectId: "society-poems-97f4d",
            storageBucket: "society-poems-97f4d.firebasestorage.app",
            messagingSenderId: "723670230106",
            appId: "1:723670230106:web:6d6dda4f8c46626c55a463"
        };
        
        let app, auth, db, tokenClient;
    
        function showMessage(type, text) {
            const messageContainer = document.getElementById('message-container');
            if (!messageContainer) return;
            messageContainer.className = `message-container ${type}-message`;
            messageContainer.textContent = text;
            messageContainer.style.display = 'block';
        }
    
        // --- GOOGLE API CLIENT LOGIC ---
        function gapiLoaded() {
            gapi.load('client', initializeGapiClient);
        }
    
        async function initializeGapiClient() {
            await gapi.client.init({
                apiKey: API_KEY,
                discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/gmail/v1/rest"],
            });
        }
    
        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: 'https://www.googleapis.com/auth/gmail.send',
                callback: '',
            });
        }
    
        function handleFormSubmit(e) {
            e.preventDefault();
            tokenClient.callback = async (resp) => {
                if (resp.error !== undefined) { throw (resp); }
                await sendEmail();
            };
    
            if (gapi.client.getToken() === null) {
                tokenClient.requestAccessToken({prompt: 'consent'});
            } else {
                tokenClient.requestAccessToken({prompt: ''});
            }
        }
    
        async function sendEmail() {
            showMessage('info', 'Sending email...');
            const name = document.getElementById('name').value;
            const fromEmail = document.getElementById('email').value;
            const message = document.getElementById('message').value;
    
            const emailLines = [
                'Content-Type: text/plain; charset="UTF-8"', `To: ${TO_EMAIL}`, `From: ${fromEmail}`,
                `Subject: New Feedback from ${name}`, '', message
            ].join('\r\n');
    
            const base64EncodedEmail = btoa(unescape(encodeURIComponent(emailLines)));
    
            try {
                await gapi.client.gmail.users.messages.send({
                    'userId': 'me', 'resource': { 'raw': base64EncodedEmail }
                });
                showMessage('success', 'Thank you! Your feedback has been sent.');
                document.getElementById('feedbackForm').reset();
            } catch (error) {
                console.error(error);
                showMessage('error', `Error sending email. Please try again.`);
            }
        }
        
        // --- SHARED PAGE LOGIC ---
        document.addEventListener('DOMContentLoaded', () => {
            app = firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
            db = firebase.database();
    
            const setupMobileMenu_impl = () => { /* ... your menu logic ... */ };
    
            const handleLogout_impl = () => {
                const logoutBtn = document.getElementById('logoutBtn');
                if (logoutBtn) {
                    logoutBtn.addEventListener('click', () => {
                        auth.signOut().then(() => {
                            window.location.href = 'index.html';
                        }).catch(error => console.error('Sign out error', error));
                    });
                }
            };
            
            // --- CORRECTED AUTH STATE CHECK ---
            const checkAuthState_impl = () => {
                auth.onAuthStateChanged(user => {
                    // If the user is not logged into Firebase, send them to the login page.
                    if (!user) {
                        window.location.href = 'login.html';
                    } else {
                        // If the user *is* logged in, just make the page visible.
                        // The Google Auth flow will be handled by the button click.
                        document.body.style.visibility = 'visible';
                    }
                });
            };
    
            setupMobileMenu_impl();
            handleLogout_impl();
            checkAuthState_impl();
            document.getElementById('feedbackForm').addEventListener('submit', handleFormSubmit);
        });
    </script>
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
</head>
<body data-theme="night" style="visibility: hidden;">

    <header>
        <nav class="navbar">
            <a href="index.html" class="nav-logo">ðŸ“– Society Poems</a>
            <button id="menu-open-button" class="fas fa-bars"></button>
            <ul class="nav-menu">
                <button id="menu-close-button" class="fas fa-times"></button>
                <li><a href="index.html" class="nav-link">Home</a></li>
                <li><a href="read.html" class="nav-link">Read</a></li>
                <li><a href="upload.html" class="nav-link">Upload</a></li>
                <li><a href="feedback.html" class="nav-link active">Feedback</a></li>
                <li><a id="logoutBtn" class="nav-link">Logout</a></li>
            </ul>
        </nav>
    </header>

    <main>
        <div class="form-container" style="margin: auto;">
            <h1>Feedback Form</h1>
            <p style="text-align: center; font-size: 0.9em; opacity: 0.8;">
                You will be asked to authorize with your Google account to send the feedback email.
            </p>
            <div id="message-container"></div>
            <form id="feedbackForm">
                <label for="name">Name:</label>
                <input type="text" id="name" required>
                <label for="email">Your Email:</label>

                <input type="email" id="email" required>
                <label for="message">Message:</label>
                <textarea id="message" rows="5" required></textarea>
                <button type="submit" class="form-button form-button-primary">Authorize & Send Feedback</button>
            </form>
        </div>
    </main>

    <footer>
        <p>&copy; 2025 Society Poems</p>
    </footer>

</body>
</html>